<!DOCTYPE html>
<html lang="en" data-theme="retro-dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Contactless Transit Map — Retro</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet + clustering -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* THEME TOKENS */
    :root{
      --bg:#0b0f14; --panel:#0e141d; --panel-2:#111927; --muted:#9fb0c4; --text:#e8eef6;
      --accent:#7dd3fc; --accent-2:#60a5fa; --green:#22c55e; --red:#ef4444;
      --chip:#0f1724; --border:#1b2637; --border-soft:#152233; --glow: rgba(96,165,250,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: "Space Grotesk", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --focus: 0 0 0 2px #0b0f14, 0 0 0 4px var(--accent-2);
    }
    [data-theme="retro-light"]{
      --bg:#faf8f2; --panel:#ffffff; --panel-2:#fffaf2; --muted:#5b6b7e; --text:#1a2430;
      --accent:#2563eb; --accent-2:#7c3aed; --green:#15803d; --red:#b91c1c;
      --chip:#f3efe6; --border:#e9e2d6; --border-soft:#efe7db; --glow: rgba(124,58,237,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    /* BASE */
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); overflow-x:hidden}
    #app{display:grid; grid-template-columns:minmax(300px,380px) 1fr; grid-template-rows: 72px 1fr; height:100%; max-width:100vw; position:relative}

    /* A subtle grain/scanline overlay for retro vibe */
    .noise{
      pointer-events:none; position:fixed; inset:0; opacity:.05; mix-blend-mode:overlay;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,.07) 0px, transparent 1px, transparent 2px),
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="1" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.09"/></svg>');
    }

    /* HEADER */
    header{
      grid-column:1/3; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:0 18px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(19,27,40,.9), rgba(10,14,20,.9));
      position:relative;
    }
    header::after{ /* tiny neon underline */
      content:""; position:absolute; left:0; right:0; bottom:-1px; height:1px; background:
      linear-gradient(90deg, transparent, var(--accent-2), transparent);
      opacity:.35;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:radial-gradient(circle at 35% 35%, #fff, var(--accent-2) 35%, transparent 60%);
      box-shadow:0 0 16px var(--glow);
    }
    h1{font-size:18px; letter-spacing:.2px; margin:0}
    .sub{color:var(--muted); font-size:12px; max-width:70ch}
    .controls{display:flex; align-items:center; gap:8px}
    .pill{background:var(--panel-2); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted)}
    button{
      background:var(--panel-2); border:1px solid var(--border); color:var(--text);
      border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer; box-shadow:var(--shadow);
      transition:transform .08s ease, border-color .2s ease, box-shadow .2s ease;
    }
    button:hover{border-color:var(--accent-2); box-shadow:0 0 0 4px var(--glow)}
    button:active{transform:translateY(1px)}
    .toggle{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background:var(--panel-2); cursor:pointer; font-size:12px;
    }

    /* SIDEBAR (glass) */
    #filters{
      grid-row:2; grid-column:1; background:rgba(20,28,40,.65); backdrop-filter: blur(10px) saturate(1.05);
      border-right:1px solid var(--border); overflow:auto; overflow-x:hidden;
    }
    .section{padding:16px 16px 14px; border-bottom:1px solid var(--border-soft)}
    .section h2{
      font-size:12px; text-transform:uppercase; letter-spacing:.16em; color:var(--muted); margin:0 0 10px;
      font-family:var(--mono);
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; min-width:0}
    .inline-input, select.inline-input{
      width:100%; box-sizing:border-box; background:var(--panel); border:1px solid var(--border); color:var(--text);
      border-radius:12px; padding:10px 12px; font-size:13px; outline:none; max-width:100%;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    .inline-input:focus{box-shadow: var(--focus); border-color: var(--accent-2)}
    .chip{
      display:inline-flex; align-items:center; gap:6px; background:var(--chip);
      border:1px solid var(--border); border-radius:999px; padding:7px 11px; font-size:12px; cursor:pointer; user-select:none;
      transition: transform .08s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .chip:hover{transform:translateY(-1px); border-color:var(--accent-2); box-shadow:0 0 0 4px var(--glow)}
    .chip input{accent-color:var(--accent-2);}
    .help{color:var(--muted); font-size:11px; margin-top:6px; line-height:1.35}

    /* MAP */
    #map{grid-row:2; grid-column:2; height:100%}
    .leaflet-popup-content-wrapper{background:var(--panel); color:var(--text); border:1px solid var(--border); box-shadow:var(--shadow)}
    .leaflet-popup-tip{background:var(--panel); border:1px solid var(--border)}
    .leaflet-control-attribution{color:var(--muted)}

    /* LEGEND + HUD */
    .legend {
      position:absolute; right:12px; bottom:12px; background:var(--panel); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; font-size:12px; line-height:1.4; max-width:min(60vw, 360px); box-shadow:var(--shadow)
    }
    .marquee{overflow:hidden; white-space:nowrap; mask-image: linear-gradient(90deg, transparent, #000 16%, #000 84%, transparent)}
    .marquee span{display:inline-block; padding-left:100%; animation: scroll 10s linear infinite}
    @keyframes scroll { to { transform: translateX(-100%); } }

    /* FLOATING HUD for active filters */
    .hud{
      position:absolute; left:calc(300px + 12px); top:84px; right:16px; display:flex; flex-wrap:wrap; gap:8px; z-index:400;
      pointer-events:none;
    }
    .hud .tag{
      pointer-events:auto; background:var(--panel-2); border:1px solid var(--border); border-radius:999px; padding:6px 10px;
      font-size:12px; display:inline-flex; align-items:center; gap:8px;
    }
    .tag button{padding:2px 6px; font-size:11px}

    /* COMMAND PALETTE */
    .palette{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:1000;
    }
    .palette.open{display:grid}
    .palette .panel{
      width:min(680px, 92vw); background:var(--panel); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .palette .search{padding:10px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px}
    .palette input{
      flex:1; background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text); outline:none;
    }
    .palette ul{list-style:none; margin:0; padding:6px; max-height:50vh; overflow:auto}
    .palette li{padding:10px 8px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    .palette li:hover{background:var(--panel-2); border:1px solid var(--border)}
    .kbd{font-family:var(--mono); font-size:11px; color:var(--muted); border:1px solid var(--border); padding:2px 6px; border-radius:6px; background:var(--panel-2)}

    /* RESPONSIVE */
    @media (max-width: 1000px){
      #app{grid-template-columns: minmax(260px, 320px) 1fr;}
      .hud{left:calc(260px + 8px)}
    }
    @media (max-width: 760px){
      #app{grid-template-columns: 1fr; grid-template-rows: 72px auto 1fr}
      #filters{grid-column:1; grid-row:2}
      #map{grid-column:1; grid-row:3}
      .hud{left:12px; top:auto; bottom:12px}
    }
  </style>
</head>
<body>
  <div class="noise" aria-hidden="true"></div>
  <div id="app">
    <header>
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <h1>Global Contactless Transit Map</h1>
          <div class="sub">Tap · Tag · Go — Explore cities supporting open-loop contactless and native wallets.</div>
        </div>
      </div>
      <div class="controls">
        <span id="count" class="pill" aria-live="polite">0 cities</span>
        <label class="toggle" title="Toggle theme">
          <input id="themeToggle" type="checkbox" aria-label="Toggle light theme" />
          <span>Theme</span>
        </label>
        <button id="resetBtn" title="Reset filters (R)">Reset</button>
      </div>
    </header>

    <aside id="filters" aria-label="Filters">
      <div class="section">
        <h2>Search</h2>
        <input class="inline-input" id="qCity" placeholder="City ( / to focus )" aria-label="Filter by city" />
        <input class="inline-input" id="qCountry" placeholder="Country" style="margin-top:8px" aria-label="Filter by country" />
        <select class="inline-input" id="qRegionSelect" style="margin-top:8px" aria-label="Filter by region">
          <option value="">All regions</option>
        </select>
      </div>

      <div class="section">
        <h2>Contactless</h2>
        <label class="chip"><input type="checkbox" class="f-contactless" value="Yes"> Contactless supported</label>
        <label class="chip"><input type="checkbox" class="f-contactless" value="No"> Not supported</label>
      </div>

      <div class="section">
        <h2>Mobile Wallet Supported</h2>
        <label class="chip"><input type="checkbox" class="f-mobile" value="Yes"> Yes</label>
        <label class="chip"><input type="checkbox" class="f-mobile" value="No"> No</label>
      </div>

      <div class="section">
        <h2>Accepted Cards</h2>
        <div class="row" id="cardsRow"></div>
      </div>

      <div class="section">
        <h2>Transit Card Native</h2>
        <div class="row">
          <label class="chip"><input type="checkbox" class="f-native-apple" value="Yes"> Apple Wallet (Native)</label>
        </div>
        <div class="row" style="margin-top:6px">
          <label class="chip"><input type="checkbox" class="f-native-google" value="Yes"> Google Wallet (Native)</label>
        </div>
        <div class="help">“Native” means the city’s transit card can be added directly inside Apple/Google Wallet (e.g., Paris Navigo).</div>
      </div>

      <div class="section">
        <h2>Options</h2>
        <label class="chip"><input type="checkbox" id="autoZoom" checked> Auto-zoom to visible</label>
        <label class="chip"><input type="checkbox" id="clusterMode" checked> Cluster nearby cities</label>
      </div>

      <div class="section" style="font-size:12px;color:var(--muted)">
        <strong>CSV Schema</strong>
        <pre style="white-space:pre-wrap;line-height:1.5;color:var(--muted);background:var(--panel-2);padding:10px;border:1px solid var(--border);border-radius:10px;font-family:var(--mono)">City,Country,Region,lat,lng,contactless_supported,mobile_wallet_supported,accepted_cards,transit_card_native_apple,transit_card_native_google,notes,other
London,United Kingdom,Europe,51.5074,-0.1278,Yes,Yes,"Visa; Mastercard; AmEx",Yes,No,"Add Navigo card through Apple wallet App.",https://tfl.gov.uk/</pre>
      </div>
    </aside>

    <div id="map" role="application" aria-label="Map of cities supporting contactless and mobile wallets"></div>

    <!-- Active filters HUD -->
    <div class="hud" id="hud"></div>
  </div>

  <div class="legend" id="legend">
    <div><strong>Markers:</strong> <span style="color:var(--green)">green</span> = Contactless, <span style="color:var(--red)">red</span> = Not contactless.</div>
    <div class="marquee" id="ticker" style="display:none"><span>&nbsp;TAP • TAG • GO • TAP • TAG • GO •</span></div>
  </div>

  <!-- Command Palette -->
  <div class="palette" id="palette" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="panel">
      <div class="search">
        <span class="kbd">⌘/Ctrl-K</span>
        <input id="paletteInput" placeholder="Type a command… (reset, theme, search, cluster, autozoom)" />
      </div>
      <ul id="paletteList"></ul>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // --- Map init ---
  const map = L.map('map', {
    worldCopyJump: true,
    zoomSnap: .25,
    zoomDelta: .5,
    scrollWheelZoom: true,
    minZoom: 2,
    maxZoom: 18
  }).setView([20, 0], 2.2);

  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    { attribution: '&copy; OSM & CARTO', crossOrigin: true }
  ).addTo(map);

  const clusterGroup = L.markerClusterGroup({ disableClusteringAtZoom: 8 });
  const layerGroup = L.layerGroup();
  map.addLayer(clusterGroup);

  // --- Zoom behavior constants (no street-level dives) ---
  const CITY_ZOOM = 8;   // Single-city zoom target (metro scale)
  const FIT_MAX_ZOOM = 7; // Cap fitBounds so it never goes street-level

  // --- State ---
  let rows = [];    // parsed CSV rows (objects)
  let markers = []; // { marker, row }
  let cardSet = new Set();
  let regionSet = new Set();

  // UI refs
  const $$  = sel => document.querySelector(sel);
  const $$$ = sel => Array.from(document.querySelectorAll(sel));
  const qCity = $$('#qCity');
  const qCountry = $$('#qCountry');
  const qRegionSelect = $$('#qRegionSelect');
  const autoZoom = $$('#autoZoom');
  const clusterMode = $$('#clusterMode');
  const countEl = $$('#count');
  const resetBtn = $$('#resetBtn');
  const cardsRow = $$('#cardsRow');
  const hud = $$('#hud');
  const ticker = $$('#ticker');
  const themeToggle = $$('#themeToggle');

  // Palette
  const palette = $$('#palette');
  const paletteInput = $$('#paletteInput');
  const paletteList = $$('#paletteList');

  // --- CSV loading ---
  async function tryLoadLocalCSV() {
    try {
      const res = await fetch('./cities.csv', { cache: 'no-store' }); // same folder
      if (!res.ok) throw new Error('Missing ./cities.csv');
      const text = await res.text();
      loadCSV(text);
    } catch (e) {
      console.warn('Could not auto-load ./cities.csv. Use the file picker.', e);
      // still attempt to read URL params / restore state so UI feels alive
      restoreStateFromURL();
      restoreStateFromStorage();
    }
  }

  function loadCSV(text) {
    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
    rows = parsed.data.map(cleanRow).filter(r => r.city && r.country);
    buildFacetSets(rows);
    buildCardsChips();
    buildRegionDropdown();
    drawMarkers();
    applyFiltersAndRender();
    restoreStateFromURL();
    restoreStateFromStorage();
    applyFiltersAndRender();
  }

  function cleanRow(r){
    const pick = (obj, keys) => {
      for (const k of keys){ if (obj[k] != null && String(obj[k]).trim() !== '') return obj[k]; }
      return '';
    };
    const norm = v => (v||'').toString().trim();
    const split = v => norm(v).length ? norm(v).split(';').map(s=>s.trim()).filter(Boolean) : [];
    const yn = v => norm(v); // keep Yes/No text

    const city = pick(r, ['City','city']);
    const country = pick(r, ['Country','country']);
    const region = pick(r, ['Region','region']);
    const lat = parseFloat(pick(r, ['lat','Lat','latitude','Latitude']));
    const lng = parseFloat(pick(r, ['lng','Lng','lon','Lon','longitude','Longitude']));
    const contactless = pick(r, ['contactless_supported','Contactless_supported']);
    const cards = pick(r, ['accepted_cards','Accepted_cards','Cards']);
    const mobile = pick(r, ['mobile_wallet_supported','Mobile_wallet_supported','Apple Pay','ApplePay']);
    const nativeApple = pick(r, ['transit_card_native_apple','Transit_card_native_apple']);
    const nativeGoogle = pick(r, ['transit_card_native_google','Transit_card_native_google']);
    const notes = pick(r, ['notes','Notes']);
    const other = pick(r, ['other','Other','website','Website','url','URL']);

    return {
      city: norm(city),
      country: norm(country),
      region: norm(region),
      lat: Number.isFinite(lat) ? lat : undefined,
      lng: Number.isFinite(lng) ? lng : undefined,
      contactless_supported: yn(contactless),
      mobile_wallet_supported: yn(mobile),
      accepted_cards: split(cards),
      transit_card_native_apple: yn(nativeApple),
      transit_card_native_google: yn(nativeGoogle),
      notes: norm(notes),
      other: norm(other)
    };
  }

  function buildFacetSets(list){
    cardSet.clear(); regionSet.clear();
    list.forEach(r => {
      r.accepted_cards.forEach(c => cardSet.add(c));
      if (r.region) regionSet.add(r.region);
    });
  }

  function mkChip(label, cls){
    const el = document.createElement('label');
    el.className = 'chip';
    el.innerHTML = `<input type="checkbox" class="${cls}" value="${escapeAttr(label)}"> ${escapeHtml(label)}`;
    return el;
  }

  function buildCardsChips(){
    cardsRow.innerHTML = '';
    Array.from(cardSet).sort().forEach(c => cardsRow.appendChild(mkChip(c,'f-card')));
    $$$('.chip input').forEach(inp => inp.addEventListener('change', onFilterChanged));
  }

  function buildRegionDropdown(){
    const current = qRegionSelect.value;
    qRegionSelect.innerHTML = '<option value="">All regions</option>';
    Array.from(regionSet).sort().forEach(reg => {
      const opt = document.createElement('option');
      opt.value = reg; opt.textContent = reg;
      qRegionSelect.appendChild(opt);
    });
    if ([...qRegionSelect.options].some(o => o.value === current)) {
      qRegionSelect.value = current;
    }
  }

  function markerForRow(r){
    const supported = (r.contactless_supported||'').toLowerCase() === 'yes';
    const color = supported ? '#22c55e' : '#ef4444';
    const marker = L.circleMarker([r.lat, r.lng], {
      radius: 7, color, fillColor: color, fillOpacity: 0.78, weight: 1
    });

    const cardStr = r.accepted_cards.join('; ');
    const desc = r.notes ? `<p style="margin:.25rem 0 0 0">${escapeHtml(r.notes)}</p>` : '';
    const webLinks = linksFromOther(r.other);
    const web = webLinks.length
      ? `<p style="margin:.25rem 0 0 0">${webLinks.map(h => `<a href="${escapeAttr(h)}" target="_blank" rel="noopener" style="display:inline-block;border:1px solid #223146;padding:2px 6px;border-radius:6px">Website ↗</a>`).join(' &nbsp; ')}</p>`
      : '';

    const mobileStr = r.mobile_wallet_supported ? r.mobile_wallet_supported : '';
    const nativeAppleStr = r.transit_card_native_apple ? r.transit_card_native_apple : '';
    const nativeGoogleStr = r.transit_card_native_google ? r.transit_card_native_google : '';

    marker.bindPopup(`
      <div style="min-width:260px">
        <div style="font-weight:600">${escapeHtml(r.city)}${r.country ? ', ' + escapeHtml(r.country) : ''}</div>
        ${r.region ? `<div style="font-size:12px;color:#9aa6b2; margin-top:2px">${escapeHtml(r.region)}</div>` : ''}
        <div style="height:1px;background:#1e2a3d;margin:8px 0"></div>
        <div style="font-size:12px;color:#9aa6b2">Contactless: <strong style="color:inherit">${supported? 'Yes':'No'}</strong></div>
        ${mobileStr ? `<div style="font-size:12px;margin-top:4px"><strong>Mobile wallet:</strong> ${escapeHtml(mobileStr)}</div>` : ''}
        ${cardStr? `<div style="font-size:12px;margin-top:4px"><strong>Cards:</strong> ${escapeHtml(cardStr)}</div>`:''}
        ${nativeAppleStr ? `<div style="font-size:12px;margin-top:4px"><strong>Native in Apple Wallet:</strong> ${escapeHtml(nativeAppleStr)}</div>`:''}
        ${nativeGoogleStr ? `<div style="font-size:12px;margin-top:4px"><strong>Native in Google Wallet:</strong> ${escapeHtml(nativeGoogleStr)}</div>`:''}
        ${desc}
        ${web}
      </div>
    `);
    return marker;
  }

  function linksFromOther(other){
    const s = (other||'').trim();
    if (!s) return [];
    const parts = s.split(/[\s;,]+/).filter(Boolean);
    const links = [];
    parts.forEach(p => {
      let t = p.trim();
      if (!t) return;
      if (!/^https?:\/\//i.test(t)) {
        if (/^[\w.-]+\.[a-z]{2,}/i.test(t)) t = 'https://' + t;
      }
      if (/^https?:\/\//i.test(t)) links.push(t);
    });
    return Array.from(new Set(links));
  }

  function drawMarkers(){
    clusterGroup.clearLayers(); layerGroup.clearLayers(); markers = [];
    rows.forEach(r => {
      if (!Number.isFinite(r.lat) || !Number.isFinite(r.lng)) return;
      const m = markerForRow(r);
      markers.push({ marker: m, row: r });
      clusterGroup.addLayer(m);
      layerGroup.addLayer(m);
    });
  }

  function getCheckedValues(cls){ return $$$(`.${cls}:checked`).map(i => i.value); }

  function applyFiltersAndRender(){
    const qC = qCity.value.trim().toLowerCase();
    const qCo = qCountry.value.trim().toLowerCase();
    const qR = (qRegionSelect.value || '').trim().toLowerCase();

    const wantContactless = getCheckedValues('f-contactless'); // [Yes, No]
    const wantMobile = getCheckedValues('f-mobile');           // [Yes, No]
    const wantCards = new Set(getCheckedValues('f-card'));     // multi
    const wantNativeApple = getCheckedValues('f-native-apple');// [Yes]
    const wantNativeGoogle = getCheckedValues('f-native-google');// [Yes]

    const visible = [];
    markers.forEach(({marker, row}) => {
      let ok = true;
      if (qC  && !row.city.toLowerCase().includes(qC)) ok = false;
      if (ok && qCo && !row.country.toLowerCase().includes(qCo)) ok = false;
      if (ok && qR){
        const reg = (row.region||'').toLowerCase();
        if (reg !== qR) ok = false; // dropdown exact match
      }
      if (ok && wantContactless.length){
        if (!wantContactless.includes((row.contactless_supported||'').trim())) ok = false;
      }
      if (ok && wantMobile.length){
        if (!wantMobile.includes((row.mobile_wallet_supported||'').trim())) ok = false;
      }
      if (ok && wantNativeApple.length){
        if (!wantNativeApple.includes((row.transit_card_native_apple||'').trim())) ok = false;
      }
      if (ok && wantNativeGoogle.length){
        if (!wantNativeGoogle.includes((row.transit_card_native_google||'').trim())) ok = false;
      }
      if (ok && wantCards.size){
        for (const c of wantCards){ if (!row.accepted_cards.includes(c)) { ok = false; break; } }
      }

      if (ok){ visible.push(marker); marker.addTo(clusterMode.checked ? clusterGroup : layerGroup); }
      else { marker.removeFrom(clusterMode.checked ? clusterGroup : layerGroup); }
    });

    if (clusterMode.checked){ map.addLayer(clusterGroup); map.removeLayer(layerGroup); }
    else { map.addLayer(layerGroup); map.removeLayer(clusterGroup); }

    // Count HUD + ticker
    countEl.textContent = `${visible.length} ${visible.length===1?'city':'cities'}`;
    ticker.style.display = visible.length ? 'block' : 'none';

    // ---- Auto-zoom behavior (no street-level dive) ----
    if (autoZoom.checked && visible.length){
      if (visible.length === 1) {
        const ll = visible[0].getLatLng();
        const targetZ = Math.min(CITY_ZOOM, FIT_MAX_ZOOM);
        map.flyTo(ll, targetZ, { duration: 0.6 });
      } else {
        const grp = L.featureGroup(visible);
        map.flyToBounds(grp.getBounds().pad(0.2), { duration: 0.6, maxZoom: FIT_MAX_ZOOM });
      }
    }

    // Render active filters HUD
    renderHUD();
    // Persist & URL
    persistState();
    updateURLParams();
  }

  function renderHUD(){
    const tags = [];
    const push = (label, clearFn) => tags.push({ label, clearFn });

    if (qCity.value) push(`City: ${qCity.value}`, () => { qCity.value=''; onFilterChanged(); });
    if (qCountry.value) push(`Country: ${qCountry.value}`, () => { qCountry.value=''; onFilterChanged(); });
    if (qRegionSelect.value) push(`Region: ${qRegionSelect.value}`, () => { qRegionSelect.value=''; onFilterChanged(); });

    $$$('.f-contactless:checked').forEach(i => push(`Contactless: ${i.value}`, () => { i.checked=false; onFilterChanged(); }));
    $$$('.f-mobile:checked').forEach(i => push(`Mobile: ${i.value}`, () => { i.checked=false; onFilterChanged(); }));
    $$$('.f-native-apple:checked').forEach(i => push(`Apple Native`, () => { i.checked=false; onFilterChanged(); }));
    $$$('.f-native-google:checked').forEach(i => push(`Google Native`, () => { i.checked=false; onFilterChanged(); }));
    $$$('.f-card:checked').forEach(i => push(`Card: ${i.value}`, () => { i.checked=false; onFilterChanged(); }));

    hud.innerHTML = '';
    tags.forEach(t => {
      const el = document.createElement('span');
      el.className = 'tag';
      el.innerHTML = `${escapeHtml(t.label)} <button title="Clear">×</button>`;
      el.querySelector('button').addEventListener('click', t.clearFn);
      hud.appendChild(el);
    });
  }

  // Escape helpers
  function escapeHtml(str){ return (str||'').replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  function escapeAttr(str){ return escapeHtml(str).replace(/\s/g, '%20'); }

  // Debounce
  function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), wait); }; }
  const onFilterChanged = debounce(applyFiltersAndRender, 160);

  // Events
  

  qCity.addEventListener('input', onFilterChanged);
  qCountry.addEventListener('input', onFilterChanged);
  qRegionSelect.addEventListener('change', applyFiltersAndRender);
  autoZoom.addEventListener('change', applyFiltersAndRender);
  clusterMode.addEventListener('change', applyFiltersAndRender);

  resetBtn.addEventListener('click', () => {
    qCity.value = ''; qCountry.value=''; qRegionSelect.value = '';
    $$$('.chip input').forEach(i => i.checked = false);
    autoZoom.checked = true; clusterMode.checked = true;
    applyFiltersAndRender();
  });

  // --- Theme toggle ---
  function setTheme(mode){
    document.documentElement.setAttribute('data-theme', mode);
    themeToggle.checked = (mode === 'retro-light');
    localStorage.setItem('gctm_theme', mode);
  }
  themeToggle.addEventListener('change', () => setTheme(themeToggle.checked ? 'retro-light' : 'retro-dark'));

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    const mod = e.metaKey || e.ctrlKey;
    if (e.key === '/' && !isTypingInField(e)) { e.preventDefault(); qCity.focus(); qCity.select(); }
    if ((e.key.toLowerCase() === 'k' && mod)) { e.preventDefault(); openPalette(); }
    if (e.key.toLowerCase() === 'r' && !isTypingInField(e)) { e.preventDefault(); resetBtn.click(); }
    if (e.key === '?' && !isTypingInField(e)) { e.preventDefault(); openPalette('?'); }
  });
  function isTypingInField(e){
    const t = e.target;
    return t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.getAttribute('contenteditable') === 'true');
  }

  // --- Command Palette ---
  const commands = [
    { key: 'search city', hint:'Focus city input', run: () => { qCity.focus(); qCity.select(); } },
    { key: 'reset', hint:'Clear all filters', run: () => resetBtn.click() },
    { key: 'toggle theme', hint:'Light/Dark', run: () => themeToggle.click() },
    { key: 'toggle cluster', hint:'Cluster markers on/off', run: () => { clusterMode.checked = !clusterMode.checked; applyFiltersAndRender(); } },
    { key: 'toggle autozoom', hint:'Auto zoom map on/off', run: () => { autoZoom.checked = !autoZoom.checked; } },
    { key: 'copy link', hint:'Copy shareable filtered URL', run: copyShareURL },
  ];
  function openPalette(preset){
    palette.classList.add('open');
    palette.setAttribute('aria-hidden','false');
    renderPaletteList(commands);
    paletteInput.value = preset && preset !== '?' ? preset : '';
    setTimeout(()=>paletteInput.focus(), 0);
  }
  function closePalette(){
    palette.classList.remove('open');
    palette.setAttribute('aria-hidden','true');
  }
  function renderPaletteList(items){
    paletteList.innerHTML = '';
    items.forEach(c => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${escapeHtml(c.key)}</span> <span class="kbd">${escapeHtml(c.hint)}</span>`;
      li.addEventListener('click', () => { c.run(); closePalette(); });
      paletteList.appendChild(li);
    });
  }
  palette.addEventListener('click', (e) => { if (e.target === palette) closePalette(); });
  document.addEventListener('keydown', (e) => { if (palette.classList.contains('open') && e.key === 'Escape') closePalette(); });
  paletteInput.addEventListener('input', () => {
    const q = paletteInput.value.toLowerCase();
    const filt = commands.filter(c => c.key.includes(q) || c.hint.toLowerCase().includes(q));
    renderPaletteList(filt.length ? filt : [{key:'No results', hint:'', run:()=>{}}]);
  });

  // --- Persist/Restore + URL params ---
  function persistState(){
    const st = {
      qCity: qCity.value, qCountry: qCountry.value, qRegion: qRegionSelect.value,
      contactless: getCheckedValues('f-contactless'),
      mobile: getCheckedValues('f-mobile'),
      nativeApple: getCheckedValues('f-native-apple'),
      nativeGoogle: getCheckedValues('f-native-google'),
      cards: getCheckedValues('f-card'),
      autoZoom: autoZoom.checked, clusterMode: clusterMode.checked,
      map: { center: map.getCenter(), zoom: map.getZoom() },
      theme: document.documentElement.getAttribute('data-theme')
    };
    localStorage.setItem('gctm_state', JSON.stringify(st));
  }
  function restoreStateFromStorage(){
    try{
      const raw = localStorage.getItem('gctm_state'); if (!raw) return;
      const st = JSON.parse(raw);
      if (st.theme) setTheme(st.theme);

      qCity.value = st.qCity || ''; qCountry.value = st.qCountry || ''; qRegionSelect.value = st.qRegion || '';
      autoZoom.checked = st.autoZoom ?? true; clusterMode.checked = st.clusterMode ?? true;

      const setChecks = (cls, vals=[]) => $$$('.'+cls).forEach(i => i.checked = vals.includes(i.value));
      setChecks('f-contactless', st.contactless);
      setChecks('f-mobile', st.mobile);
      setChecks('f-native-apple', st.nativeApple);
      setChecks('f-native-google', st.nativeGoogle);
      setChecks('f-card', st.cards);

      if (st.map && st.map.center && typeof st.map.zoom === 'number'){
        map.setView([st.map.center.lat, st.map.center.lng], st.map.zoom);
      }
    }catch(e){ console.warn('restoreStateFromStorage failed', e); }
  }
  function updateURLParams(){
    const p = new URLSearchParams();
    if (qCity.value) p.set('city', qCity.value);
    if (qCountry.value) p.set('country', qCountry.value);
    if (qRegionSelect.value) p.set('region', qRegionSelect.value);
    const push = (k, arr) => { if (arr.length) p.set(k, arr.join(',')); };
    push('contactless', getCheckedValues('f-contactless'));
    push('mobile', getCheckedValues('f-mobile'));
    push('apple', getCheckedValues('f-native-apple'));
    push('google', getCheckedValues('f-native-google'));
    push('cards', getCheckedValues('f-card'));
    p.set('cluster', clusterMode.checked ? '1':'0');
    p.set('autozoom', autoZoom.checked ? '1':'0');
    const c = map.getCenter();
    p.set('lat', c.lat.toFixed(4)); p.set('lng', c.lng.toFixed(4)); p.set('z', String(map.getZoom()));
    const newUrl = `${location.pathname}?${p.toString()}`;
    history.replaceState(null, '', newUrl);
  }
  function restoreStateFromURL(){
    const p = new URLSearchParams(location.search);
    if (p.get('city')) qCity.value = p.get('city');
    if (p.get('country')) qCountry.value = p.get('country');
    if (p.get('region')) qRegionSelect.value = p.get('region');

    const setList = (cls, key) => {
      const v = p.get(key); if (!v) return;
      const wanted = v.split(',').map(s=>s.trim());
      $$$('.'+cls).forEach(i => i.checked = wanted.includes(i.value));
    };
    setList('f-contactless','contactless');
    setList('f-mobile','mobile');
    setList('f-native-apple','apple');
    setList('f-native-google','google');
    setList('f-card','cards');

    if (p.get('cluster')) clusterMode.checked = p.get('cluster') === '1';
    if (p.get('autozoom')) autoZoom.checked = p.get('autozoom') === '1';
    if (p.get('lat') && p.get('lng') && p.get('z')){
      const lat = parseFloat(p.get('lat')), lng = parseFloat(p.get('lng')), z = parseFloat(p.get('z'));
      if (Number.isFinite(lat) && Number.isFinite(lng) && Number.isFinite(z)) map.setView([lat,lng], z);
    }
  }
  function copyShareURL(){
    navigator.clipboard.writeText(location.href).then(()=> {
      countEl.textContent = 'Link copied!';
      setTimeout(applyFiltersAndRender, 900);
    });
  }

  // Update URL when panning/zooming (debounced)
  map.on('moveend zoomend', debounce(updateURLParams, 200));

  // Boot theme
  const savedTheme = localStorage.getItem('gctm_theme');
  if (savedTheme) setTheme(savedTheme); else setTheme('retro-dark');

  // Boot data
  tryLoadLocalCSV();
  </script>
</body>
</html>
